<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    /*
     *  obj: 目标对象
     *  prop: 需要操作的目标对象的属性名
     *  descriptor: 描述符
     *  return value 传入对象
     */
    
    //  订阅者
    class Dep {
      constructor () {
        /* 用来存放watcher对象的数组 */
        this.subs = [];
      }

      /* 在subs中添加一个watcher对象 */
      addSub (sub) {
        this.subs.push(sub);
      }

      /* 通知所有所有watcher对象更新视图 */
      notify () {
        this.subs.forEach(sub => {
          sub.update();
        })
      }
    }

    //  观察者
    class Watcher {
      constructor () {
        /* 在new一个watcher对象时将改对象赋值给Dep.target,在get中会用到 */
        Dep.target = this;
      }

      /* 更新视图 */
      update () {
        console.log('视图更新了');
      }
    }

    //  模拟视图更新 
    function cb(val) {
      /* 渲染视图 */
      console.log('视图更新啦');
    }

    function defineReactive (obj, key, val) {
      //  一个dep类对象
      const dep = new Dep();

      Object.defineProperty(obj, key, {
        enumerable: true,       /* 属性可枚举 */
        configurable: true,     /* 属性可被修改或删除 */
        get: function reactiveGetter () {
          //  将dep.target（即当前的watcher对象存入dep的subs中）
          dep.addSub(Dep.target);
          return val;
        },
        set: function reactiveSetter (newVal) {
          if (newVal === val) return;
          //  在set的时候触发dep的notify来通知所有的watcher对象更新视图
          val = newVal;
          dep.notify()
          // cb(newVal);
        }
      })
    }

    function observer (value) {// 递归调用
      if (!value || (typeof value !== 'object')) {
        return;
      }
      Object.keys(value).forEach((key) => {
        defineReactive(value, key, value[key]);
      })
    }
    

    
    class Vue {
      constructor(options) {
        this._data = options.data;
        observer(this._data);
        //  创建一个watcher观察者对象，这时候Dep.target会指向这个Watcher对象
        new Watcher()
        //  在这里模拟render过程，为了触发test属性的get函数
        console.log('render', this._data.test);
      }
    }
    
    let a = new Vue({
      data: {
        test: 'I am test'
      }
    })
    a._data.test = 'hahaha'
    console.log(a);

    Dep.target = null;
    </script>
</body>
</html>